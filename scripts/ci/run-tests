#!/usr/bin/env bash
case "$IDEFIX_COMPILER" in
    icc)
        source /opt/intel/oneapi/setvars.sh;;
    gricad-*)
        function remote-tests() {
            printf "Running tests : %s\n" "$*"
            declare -p IDEFIX_COMPILER GITHUB_SHA
            if [ ! -e ".github-ci/$GITHUB_SHA" ]; then
                mkdir -p ".github-ci/$GITHUB_SHA"
                cd ".github-ci/$GITHUB_SHA"
                git init
                git remote add origin "https://github.com/$GITHUB_REPOSITORY"
                git fetch origin "$GITHUB_SHA"
                git reset --hard "$GITHUB_SHA"
            fi
        }
        function run-tests() {
            local -a args=( "$@" )
            local -a vars=( args IDEFIX_COMPILER GITHUB_SHA GITHUB_REPOSITORY )
            printf "Running jobs on remote workflow host\n"
            ssh workflow "$(declare -p "${vars[@]}"); $(declare -f remote-tests); "'remote-tests "${args[@]}"'
        }
    ;;

    *)
        function run-tests() {
            cd "$1"
            ./testme.py "${@:2}"
        }
        ;;
esac

set -ue
run-tests "$@"
